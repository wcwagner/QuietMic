# QuietMic - Agent Guide

## Project Overview
iOS 26 voice recording app demonstrating background audio recording via AppIntents without foregrounding the UI. Built with Swift 6, strict concurrency, and XcodeGen.

## Frequently Used Commands

### Development Workflow
```bash
# Generate Xcode project from project.yml (ALWAYS run after modifying project.yml)
make gen

# Build, install, and launch on device (non-blocking, returns immediately)
make dev [DEVICE_ID=<udid>] [RUN_ID=latest|slug]

# Check app and supervisor status
make status

# Stop app and clear session lock
make stop

# Collect unified logs, crash reports, and app artifacts
make collect

# View live console logs
make tail

# Build only (without install/launch)
make build-only

# Clean derived data and build artifacts
make clean

# Remove old archived runs (keeps most recent N, default 10)
make prune [N=10]
```

### Important Workflow Notes
- **Always run `make gen`** after modifying `project.yml` or switching branches
- **Run `make doctor`** to verify environment (dependencies, device, sudo wrapper)
- Default session is `runs/latest/` (overwritten each run)
- Use `RUN_ID=<slug>` to create archived sessions in `runs/archive/<slug>/`
- Device ID auto-selects first connected iOS device if not specified
- `make dev` returns immediately; app runs in background with supervisor

## Project Structure

```
.
├── project.yml              # XcodeGen config (single source of truth)
├── Makefile                 # Build automation
├── Configs/
│   ├── Base.xcconfig       # Swift 6, strict concurrency settings
│   ├── Debug.xcconfig
│   ├── Release.xcconfig
│   ├── QuietMic.Info.plist # Generated by XcodeGen, tracked in git
│   └── QuietMic.entitlements
├── ios/QuietMic/
│   ├── App/                # Core app code
│   ├── Features/           # Feature modules
│   └── Resources/          # Assets.xcassets
├── QuietMicTests/          # Unit tests
├── QuietMicUITests/        # UI tests
├── bin/                    # Helper scripts (launch.sh, stop-app.sh, collect-logs.sh)
└── runs/                   # Session logs and artifacts
    ├── latest/             # Current/most recent session
    └── archive/            # Named archived sessions
```

## Code Style & Conventions

### Swift
- **Swift 6 complete concurrency** enabled - all code must compile with strict concurrency checking
- No code comments unless explicitly requested or code is complex
- Follow existing patterns in neighboring files
- Use structured logging via `Logger.swift` for JSON line output to console
- Modular organization by feature, not file type

### Build System
- **XcodeGen-first**: Project files are generated, never hand-edited
- Build settings live in `.xcconfig` files, not in YAML or Xcode GUI
- Generated plist/entitlements tracked in git to prevent merge conflicts
- In-tree DerivedData at `.derived/` for predictable paths

## Testing

### Run Tests
```bash
# Unit tests (on simulator)
xcodebuild test -scheme QuietMic -destination 'platform=iOS Simulator,name=iPhone 16 Pro'

# UI tests (on simulator)  
xcodebuild test -scheme QuietMic -destination 'platform=iOS Simulator,name=iPhone 16 Pro' -only-testing:QuietMicUITests
```

## Session Artifacts

Each run produces:
```
runs/latest/ (or runs/archive/<slug>/)
├── start.iso              # ISO timestamp when session started
├── stop.iso               # ISO timestamp when session stopped
├── console.txt            # JSON lines from app stdout (supervised)
├── app_persistent.jsonl   # On-device logs (survives restarts)
├── unified.jsonl          # Unified system logs for session window
├── summary.json           # Quick counts and metadata
├── artifacts/             # App Documents/ pulled from device
└── systemCrashLogs/       # Crash/Jetsam reports within time window
```

## App Logging Contract

The app emits JSON lines to stdout (captured in `console.txt`):
```json
{"ev":"INTENT_FIRED","run_id":"<id>"}
{"ev":"LA_START_OK","run_id":"<id>"}
{"ev":"AV_SESSION_ACTIVE","category":"playAndRecord","run_id":"<id>"}
{"ev":"REC_BEGIN","run_id":"<id>"}
{"ev":"REC_STOP","file":"Documents/rec/…m4a","duration_s":"…","bytes":"…","run_id":"<id>"}
{"ev":"ERROR","code":"…","message":"…","run_id":"<id>"}
```

## Troubleshooting

- **Stale lock**: `guard` target auto-cleans; inspect `runs/latest/supervisor.out` if needed
- **Device unplugged**: Run `make status`, reconnect device, re-run `make dev`
- **App exited mid-run**: Run `make collect` and inspect `unified.jsonl` for RunningBoard termination reason
- **UNSUPERVISED app**: iOS may restart app after `make stop`; logs won't be captured
- **Failed launch (locked device)**: No `stop.iso` written; session artifacts incomplete
- **Stop→relaunch loop**: Check no follow-up `make dev` fired; inspect `unified.jsonl`

## Dependencies

- **Required**: Xcode 16+, XcodeGen, jq, python3, macOS with iOS 26 device
- **Optional**: `xcbeautify` (for prettier build output)
- **Sudo wrapper**: Run `./setup-sudo-wrapper.sh` once for passwordless `make collect`
- **Validation**: Run `make doctor` to check all dependencies and device connectivity

## Security

- Never commit secrets or keys
- Sudo wrapper limits escalation to only `log collect` command
- All sensitive operations are read-only or device-scoped
