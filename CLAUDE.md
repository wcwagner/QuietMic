# QuietMic

Low-touch iOS 26 voice recording app that is launched via iPhone's action. This app serves as a PoC MVP demonstrating that with AppIntent's and iOS Shortcuts, it is possible to start an audio recording session *without* ever foregrounding the app or opening the UI.

## Project Structure

```
.
├─ project.yml              # XcodeGen configuration (single source of truth for Plist, entitlements, etc.)
├─ Makefile                 # Build automation (gen, build, test, clean)
├─ Configs/
│  ├─ Base.xcconfig        # Swift 6, strict/approachable concurrency, shared settings
│  ├─ Debug.xcconfig
│  ├─ Release.xcconfig
│  ├─ QuietMic.Info.plist  # Generated by XcodeGen, tracked in git
│  └─ QuietMic.entitlements # Generated by XcodeGen, tracked in git
└─ ios/
   └─ QuietMic/
      ├─ App/              # Core app code (QuietMicApp.swift, etc.)
      ├─ Features/         # Future: Audio/, Shortcuts/ modules
      └─ Resources/        # Assets.xcassets
```

## Development Workflow

**Contract:** fast, non-blocking outer loop; durable, small artifacts; “latest” by default; named archives on demand.

```mermaid
flowchart TD
  A[make dev RUN_ID=latest] --> B[launch supervisor writes start.iso]
  B --> C{User does Action Button flow}
  C --> D[make collect] --> E[artifacts + unified.jsonl for window]
  C -->|optional| S[make stop] --> D

```bash
# Build→install→launch (returns immediately). Default session is runs/latest.
make dev [DEVICE_ID=<udid>] [RUN_ID=latest|slug]

# Stop the on-device app and clear the lock; supervisor writes stop.iso.
make stop

# Snapshot unified logs + crash/Jetsam for [start.iso, stop.iso|now] and pull Documents/.
make collect

# Live logs
make tail

# Housekeeping
make prune    # keep only most recent N archives (N=10 by default)
make clean    # drop runs/latest, .derived, and build/_latest.*
```

### Files Per Run
```
runs/latest/ or runs/archive/<slug>/
  start.iso, stop.iso      # ISO timestamps bracketing the session
  console.txt              # JSON lines from app (from devicectl --console)
  unified.jsonl            # Unified log slice for the window (requires sudo)
  artifacts/               # result.json + recorded audio pulled from Documents/
  systemCrashLogs/         # Only crash/Jetsam files whose filename timestamps land in-window
  summary.json             # Tiny counts for quick reporting
```

### App contract (stdout JSON lines)

```json
{"ev":"INTENT_FIRED","run_id":"<id>"}
{"ev":"LA_START_OK","run_id":"<id>"}
{"ev":"AV_SESSION_ACTIVE","category":"playAndRecord","run_id":"<id>"}
{"ev":"REC_BEGIN","run_id":"<id>"}
{"ev":"REC_STOP","file":"Documents/rec/…m4a","duration_s":"…","bytes":"…","run_id":"<id>"}
{"ev":"ERROR","code":"…","message":"…","run_id":"<id>"}
```

**Critical**: Always run `make gen` after modifying `project.yml` or switching branches. XcodeGen uses `--use-cache` to prevent unnecessary file rewrites that can confuse Xcode's dependency tracking.

## Architecture Principles

**Agent-Intuitive Design**: One obvious place for each concern
- **Build policy**: Lives in `.xcconfig` files, not YAML
- **App metadata**: XcodeGen generates `Info.plist` and `.entitlements` in `Configs/` from inline properties in `project.yml`
- **Project wiring**: Single `project.yml` at root
- **Source organization**: Modular by feature, not by file type

**Swift 6 Complete Concurrency**: All new code must compile with strict concurrency checking enabled. This catches concurrency bugs at compile time.

**XcodeGen Over Xcode**: Project files are generated, not edited by hand. Generated plist/entitlements files are tracked in git to prevent "modified during build" conflicts and ensure reviewable changes.

## Agent Commands

### Core Commands
- `make dev [RUN_ID=latest|slug] [DEVICE_ID=…]` — Build→install→launch (returns immediately; writes start.iso)
- `make status` — Show supervisor state and app PID (JSON-based, reliable)
- `make stop` — Signal app, wait for supervisor exit, write stop.iso and cooldown
- `make collect` — Passwordless unified log collection via sudo wrapper
- `make tail` — Live console output
- `make prune` — Keep only recent N archives (default: 10)
- `make clean` — Drop runs/latest, .derived, build artifacts

### Setup Required for Agents

**Passwordless Log Collection:**
Agents need to run `make collect` without password prompts. Run this setup once:

```bash
./setup-sudo-wrapper.sh
```

This creates a secure sudo wrapper that allows only `log collect` command and configures passwordless access following security best practices.

**Required Tools:**
- `jq` for JSON parsing (device process detection)
- `xcodegen` for project generation
- `xcbeautify` for token-efficient build output

## Troubleshooting

### Common Agent Scenarios

**Device disconnected:**
- `make dev` will fail early if no `DEVICE_ID` is detected
- Always run `make status` first to check device availability
- Reconnect device and re-run `make dev`
- `cfgutil` syslog will also stop if device disconnects

**App not found but supervisor RUNNING:**
- The app exited on device (user quit, iOS termination, crash)
- Run `make collect` to gather logs, then `make status` to confirm
- Check `unified.jsonl` for RunningBoard `terminate;` events and reasons
- Do NOT relaunch until you've reviewed the termination cause

**Stop → app appears to relaunch immediately:**
- Do NOT automatically re-run `make dev` after `make stop`
- First run `make status` to verify supervisor is STOPPED
- Check unified logs: if RunningBoard shows `launch;` with `system/user interaction`, iOS relaunched
- If you see devicectl `Launched application…` output, the agent relaunched it—stop and investigate

**Stale lock warnings:**
- "stale lock found; cleaning" means previous session didn't exit cleanly
- Guard automatically removes stale locks safely
- Inspect `runs/latest/supervisor.out` for context if needed
- Session state is preserved; you can proceed normally

**Collection failures:**
- If `make collect` asks for password: run `./setup-sudo-wrapper.sh` setup
- If unified logs are empty: check device connection and time windows
- `cfgutil` syslog is optional; unified logs remain the authoritative source

### Status Output Examples

```bash
# Healthy running session
Session dir: runs/latest
Supervisor: RUNNING
Device app: pid=12345 (RUNNING)

# App stopped but supervisor cleaning up
Session dir: runs/latest
Supervisor: RUNNING
Device app: not found

# Session fully stopped
Session dir: runs/latest
Supervisor: STOPPED
Device app: not found

# Device disconnected
Session dir: runs/latest
Supervisor: RUNNING
Device app: device unavailable
```

### Debugging Device App Issues

After collecting logs, use this to find termination/launch reasons:

```bash
jq -r 'select(.subsystem=="com.apple.runningboard" and (.eventMessage|test("launch|terminate"; "i")))
       | [.timestamp,.process,.eventMessage] | @tsv' runs/<RUN_ID>/unified.jsonl | tail -n 20
```

Look for patterns:
- `terminate; (reason: jetsam)` → Memory pressure
- `terminate; (reason: user request)` → User force-quit
- `launch; (reason: system.user interaction)` → iOS relaunched after user action
- Fresh `devicectl` session → Agent relaunched
