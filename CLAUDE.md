# QuietMic

Low-touch iOS 26 voice recording app that is launched via iPhone's action. This app serves as a PoC MVP demonstrating that with AppIntent's and iOS Shortcuts, it is possible to start an audio recording session *without* ever foregrounding the app or opening the UI.

## Project Structure

```
.
├─ project.yml              # XcodeGen configuration (single source of truth for Plist, entitlements, etc.)
├─ Makefile                 # Build automation (gen, build, test, clean)
├─ Configs/
│  ├─ Base.xcconfig        # Swift 6, strict/approachable concurrency, shared settings
│  ├─ Debug.xcconfig
│  ├─ Release.xcconfig
│  ├─ QuietMic.Info.plist  # Generated by XcodeGen, tracked in git
│  └─ QuietMic.entitlements # Generated by XcodeGen, tracked in git
└─ ios/
   └─ QuietMic/
      ├─ App/              # Core app code (QuietMicApp.swift, etc.)
      ├─ Features/         # Future: Audio/, Shortcuts/ modules
      └─ Resources/        # Assets.xcassets
```

## Development Workflow

**Contract:** fast, non-blocking outer loop; durable, small artifacts; “latest” by default; named archives on demand.

```mermaid
flowchart TD
  A[make dev RUN_ID=latest] --> B[launch supervisor writes start.iso]
  B --> C{User does Action Button flow}
  C --> D[make collect] --> E[artifacts + unified.jsonl for window]
  C -->|optional| S[make stop] --> D

```bash
# Build→install→launch (returns immediately). Default session is runs/latest.
make dev [DEVICE_ID=<udid>] [RUN_ID=latest|slug]

# Stop the on-device app and clear the lock; supervisor writes stop.iso.
make stop

# Snapshot unified logs + crash/Jetsam for [start.iso, stop.iso|now] and pull Documents/.
make collect

# Live logs
make tail

# Housekeeping
make prune    # keep only most recent N archives (N=10 by default)
make clean    # drop runs/latest, .derived, and build/_latest.*
```

### Files Per Run
```
runs/latest/ or runs/archive/<slug>/
  start.iso, stop.iso      # ISO timestamps bracketing the session
  console.txt              # JSON lines from app (from devicectl --console)
  unified.jsonl            # Unified log slice for the window (requires sudo)
  artifacts/               # result.json + recorded audio pulled from Documents/
  systemCrashLogs/         # Only crash/Jetsam files whose filename timestamps land in-window
  summary.json             # Tiny counts for quick reporting
```

### App contract (stdout JSON lines)

```json
{"ev":"INTENT_FIRED","run_id":"<id>"}
{"ev":"LA_START_OK","run_id":"<id>"}
{"ev":"AV_SESSION_ACTIVE","category":"playAndRecord","run_id":"<id>"}
{"ev":"REC_BEGIN","run_id":"<id>"}
{"ev":"REC_STOP","file":"Documents/rec/…m4a","duration_s":"…","bytes":"…","run_id":"<id>"}
{"ev":"ERROR","code":"…","message":"…","run_id":"<id>"}
```

**Critical**: Always run `make gen` after modifying `project.yml` or switching branches. XcodeGen uses `--use-cache` to prevent unnecessary file rewrites that can confuse Xcode's dependency tracking.

## Architecture Principles

**Agent-Intuitive Design**: One obvious place for each concern
- **Build policy**: Lives in `.xcconfig` files, not YAML
- **App metadata**: XcodeGen generates `Info.plist` and `.entitlements` in `Configs/` from inline properties in `project.yml`
- **Project wiring**: Single `project.yml` at root
- **Source organization**: Modular by feature, not by file type

**Swift 6 Complete Concurrency**: All new code must compile with strict concurrency checking enabled. This catches concurrency bugs at compile time.

**XcodeGen Over Xcode**: Project files are generated, not edited by hand. Generated plist/entitlements files are tracked in git to prevent "modified during build" conflicts and ensure reviewable changes.

## Commands (delta)

make dev [RUN_ID=latest|slug] [DEVICE_ID=…]  # returns immediately; writes start.iso
make status                                   # prints supervisor state and app PID (JSON-based)
make stop                                     # signals the on-device app, waits for supervisor to exit, writes stop.iso
make collect                                  # uses passwordless sudo wrapper to run `log collect`
make prune | make clean

## Troubleshooting (new)
- Device unplugged → run `make status`; reconnect and re-run `make dev`.
- App exited mid-run → `make collect`, inspect `unified.jsonl` (RunningBoard reason), then decide.
- Stop → relaunch loop → ensure no follow-up `make dev` fired; check `unified.jsonl` for who launched.
- Stale lock → guard auto-cleans; inspect `runs/latest/supervisor.out` if curious.

## Status output (example)
Session dir: runs/latest
Supervisor: RUNNING
Device app: pid=12345 (RUNNING)
